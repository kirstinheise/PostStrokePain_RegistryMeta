---
title: "Pain_RESTORE_REX"
author: "kfh"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(root.dir = "/Users/Kirstin/Library/CloudStorage/OneDrive-MedicalUniversityofSouthCarolina/Documents/OnGoingStudies/PAIN/RESTORE_pain_metaanalysis/pain_20250127/")

```

## METAANALYSIS OF PAIN REPORTS IN RESTORE, REX


Loading required libraries ...
```{r, include=FALSE}

required_libraries <- c('plyr', 'dplyr', 'easystats', 'ggpubr', 'ggthemes', 'Rmisc', 'readr', 'readxl', 
'easystats', 'RColorBrewer', 'cols4all', 'sjPlot', 'sjmisc', 'sjlabelled', 'report', 'purrr', 'lubridate', 
'finalfit', 'flextable', 'likert', 'here', 'kableExtra', 'flextable', 'magrittr', 'correlation', "see")
                        
lapply(required_libraries, require, character.only = TRUE)     

theme_set(theme_classic())
```

Defining directories including working directory...

```{r, include=FALSE}
   
list.dirs(path = "/Users/Kirstin/Library/CloudStorage/OneDrive-MedicalUniversityofSouthCarolina/Documents/OnGoingStudies/PAIN/", full.names = TRUE, recursive = TRUE)

data_path = "/Users/Kirstin/Library/CloudStorage/OneDrive-MedicalUniversityofSouthCarolina/Documents/OnGoingStudies/PAIN/RESTORE_pain_metaanalysis/pain_20250127"
# setwd(data_path)
# getwd()
list.files(path=data_path, full.names = TRUE)

```

Loading the data...

```{r, include=FALSE}

pain1.df <- read.csv("./pain_20250127/Eq5D5L.csv")
pain2.df <- read.csv("./pain_20250127/RESTOREDatabase-PainHeise_DATA_LABELS_2025-01-27_1640.csv")
demo.df <- read.csv("./pain_20250127/RESTOREDatabase-HeisePain_StrokeData_2025-01-27_1654.csv", stringsAsFactors = F)
mds.df <- read_csv("./pain_20250127/PainScreening.csv")  # this includes the new questions included in Alyssa's MDS study
mds_wong.df <- read_csv("./pain_20250127/WongBakerFacesPainScale.csv")  # this includes the pain intensity faces/NRS from MDS
phq.df <- read_excel("./pain_20250127/PHQ8_20250505.xlsx")
sis.df <- read_csv("./pain_20250127/StrokeScale.csv")

```

Preparing the data and create required variables...

```{r, include=FALSE}

# merge data frames with common identifiers RESTORE.ID = Registry.ID & Date.Of.Evaluation = Date.of.Assessment
pain2.df$subjType <- as.factor(pain2.df$Subject.Type....Please.make.sure.the.subject.type.matches.the.event.name.above.)
levels(pain2.df$subjType) # remove controls!
CNTRLS.df  <- dplyr::filter(pain2.df, subjType == "Control")


str(pain1.df)
pain1.df$Date.of.Assessment <- as.Date(pain1.df$Date.Of.Evaluation,
                       format = "%Y-%m-%d")

length(unique(as.factor(pain1.df$Rex.ID)))

str(pain2.df)
pain2.df$RESTORE.ID <- pain2.df$Registry.ID

pain2.df$Date.of.Assessment <- as.Date(pain2.df$Date.of.Assessment,
                                       format = "%Y-%m-%d")
pain2.df$Date.of.Stroke <- as.Date(pain2.df$Date.,
                                   format = "%Y-%m-%d")
pain2.df$Date.of.Consent <- as.Date(pain2.df$Date.of.Consent,
                                   format = "%Y-%m-%d")
```

Remove controls and keep only stroke in the data frame...

```{r, include=FALSE}
cntrlNames <- levels(as.factor(CNTRLS.df$Registry.ID))  
`%not_in%` <- purrr::negate(`%in%`)
pain2_noCNTRLS.df <- pain2.df[pain2.df$RESTORE.ID  %not_in% cntrlNames, ]

str(pain2_noCNTRLS.df)

#  difftime does not work with missing values
pain2_noCNTRLS.df$time.post.stroke <- NA
for (i in 1:nrow(pain2_noCNTRLS.df)) {
  if (!is.na(pain2_noCNTRLS.df$Date.of.Assessment[i])) {
    pain2_noCNTRLS.df$time.post.stroke[i] <- difftime(pain2_noCNTRLS.df$Date.of.Assessment[i], pain2_noCNTRLS.df$Date.of.Stroke[i], units = c("days"))
  }
}

```

 Check results of data wrangling  -> in RESTORE only most recent stroke is documented with data, hence negative time differences possible for earlier assessments related to previous stroke
 
```{r}

min(pain2_noCNTRLS.df$time.post.stroke, na.rm = TRUE)
pain2_noCNTRLS.df %>%
dplyr::filter(time.post.stroke<0) %>%
  tally()
```

Check unique individuals in the dataframe
```{r,  include=FALSE}
# RESTORE_ERR <- pain2_noCNTRLS.df[, c("RESTORE.ID", "Registry.ID", "Date.of.Consent", "Date.", "Date.of.Assessment", "Date.of.Stroke", "time.post.stroke")] %>%
#   dplyr::filter(time.post.stroke<0)
# #  save out data frame as csv file
# write_csv(RESTORE_ERR, "./RESTORE_ERR.csv")

#  until corrected, replace negative times with NA
pain2_noCNTRLS.df$time.post.stroke <- replace(pain2_noCNTRLS.df$time.post.stroke, which(pain2_noCNTRLS.df$time.post.stroke<0), NA)


# str(pain2_noCNTRLS.df)
length(unique(as.factor(pain2_noCNTRLS.df$Registry.ID)))
#  N=1530
```

Recode variables ...
```{r,  include=FALSE}
names <- c(8:14) # only those columns related to pain yes/no
pain2_noCNTRLS.df[,names] <- lapply(pain2_noCNTRLS.df[,names] , factor)

levels(pain2_noCNTRLS.df[, 8]) 
level_key <- c(Checked = 1, Unchecked = 0)
pain2_noCNTRLS.df[names] <- lapply(pain2_noCNTRLS.df[names] , function(x) {levels(x) <- level_key; x })
# str(pain2_noCNTRLS.df)

pain2_noCNTRLS.df$noArmPain <- as.factor(pain2_noCNTRLS.df$Do.you.experience.PAIN.in.your.more.affected.arm...choice.No.)
pain2_noCNTRLS.df$constantArmPain <- as.factor(pain2_noCNTRLS.df$Do.you.experience.PAIN.in.your.more.affected.arm...choice.Constantly.)
pain2_noCNTRLS.df$moveArmPain <- as.factor(pain2_noCNTRLS.df$Do.you.experience.PAIN.in.your.more.affected.arm...choice.During.Movement.)
pain2_noCNTRLS.df$nightArmPain <- as.factor(pain2_noCNTRLS.df$Do.you.experience.PAIN.in.your.more.affected.arm...choice.Waking.at.Night.)
pain2_noCNTRLS.df$chrncFibromyalgPain <- as.factor(pain2_noCNTRLS.df$Chronic.Pain..choice.Fibromyalgia.)
pain2_noCNTRLS.df$chrncBackPain  <- as.factor(pain2_noCNTRLS.df$Chronic.Pain..choice.Severe.Back.Pain.)
pain2_noCNTRLS.df$chrncJointPain <- as.factor(pain2_noCNTRLS.df$Chronic.Pain..choice.Severe.Joint.Pain.)

# str(pain2_noCNTRLS.df)
levels(as.factor(pain2_noCNTRLS.df[, 2]))
pain2_noCNTRLS.df[, 2] <- as.factor(pain2_noCNTRLS.df[, 2])



newnames <- c(22:28)
pain2_noCNTRLS.df[newnames] <- lapply(pain2_noCNTRLS.df[newnames], as.character)
pain2_noCNTRLS.df[newnames] <- lapply(pain2_noCNTRLS.df[newnames], as.integer)
#  select only the "1"
noPain <- pain2_noCNTRLS.df %>%
  dplyr::filter(noArmPain == 1)


```

Time frame of enrollment:
```{r}
## ---- 
min(pain2_noCNTRLS.df$Date.of.Consent, na.rm = T)
# "2015-03-20"
max(pain2_noCNTRLS.df$Date.of.Consent, na.rm = T)
#  "2025-01-25"
```

# ANALYSES

## Descriptives related to affected UE pain

```{r, include=FALSE}
noPain_sum <- pain2_noCNTRLS.df %>%
  group_by(Event.Name, noArmPain) %>%  # grouping by these two variables
  tally() %>%  # counting the number of responses
  mutate(perc = n / sum(n) * 100) %>%
  dplyr::select(-n) %>%
  group_by(Event.Name) #%>%
  # tidyr::spread(noArmPain, perc)

noPain_sum$noArmPain <- as.factor(noPain_sum$noArmPain )

```


```{r}
legend_pal <- brewer.pal(name = "RdBu", n = 3)
legend_pal <- gsub("#F7F7F7", "#9C9C9C", legend_pal)
ggplot() +
    geom_bar(data = noPain_sum, aes(x = Event.Name, y=perc, fill = noArmPain), stat="identity") +
    geom_hline(yintercept = 50, color =c("black")) +
    scale_fill_manual(values = legend_pal,
                      labels = c("pain", "no pain")) +
    coord_flip() +
    labs(x = "Time of survey", y = "Percentage of respondents (%)") +
    ggtitle("RESTORE: Pain in the paretic arm?") +
    theme_classic() + theme(legend.title = element_blank())

```


collapse across visits

```{r, include=FALSE}
# str(pain2_noCNTRLS.df)

# +++  to do: change order of plotting: Pain first +++

noPain_sum <- unique.data.frame( pain2_noCNTRLS.df[, c("RESTORE.ID", "subjType", "noArmPain")]) %>%
  group_by(noArmPain) %>%  # grouping by these two variables 
  tally() %>%  # counting the number of responses
  mutate(perc = n / sum(n) * 100) %>%
  dplyr::select(-n) #%>%
# tidyr::spread(noArmPain, perc)

noPain_sum$noArmPain <- as.factor(noPain_sum$noArmPain )
```


```{r, include_graphics}

ggplot() +
    geom_bar(data = noPain_sum, aes( x= as.factor(1), y=perc, fill = noArmPain), stat="identity") +
    geom_hline(yintercept = 50, color =c("black")) +
    scale_fill_manual(values = legend_pal,
                      labels = c("pain", "no pain")) +
    coord_flip() +
    labs(x = "", y = "Percentage of respondents (%)") +
    ggtitle("RESTORE: Pain in the paretic arm?") +
    theme_classic() + theme(legend.title = element_blank())

```



subset to those who have pain in the UE

```{r,  include=FALSE}
UEpain.df <- dplyr::filter(unique.data.frame( 
  pain2_noCNTRLS.df[, c("RESTORE.ID", "subjType", "noArmPain", "constantArmPain", "moveArmPain", "nightArmPain")]), 
  noArmPain==0)


# constPain_sum <- unique(pain2_noCNTRLS.df[, c(1, 15, 19)]) %>%
  constPain_sum <- UEpain.df %>%
  group_by(constantArmPain) %>%  # grouping by these two variables
  tally() %>%  # counting the number of responses
  mutate(perc = n / sum(n) * 100) %>%
  dplyr::select(-n) #%>%
# tidyr::spread(constantArmPain, perc)

constPain_sum$constantArmPain <- as.factor(constPain_sum$constantArmPain)
```


```{r}
legend_pal <- brewer.pal(name = "RdBu", n = 3)
legend_pal <- gsub("#F7F7F7", "#de2d26", legend_pal)
ggplot() +
    geom_bar(data = constPain_sum, aes(x= as.factor(1), y=perc, fill = constantArmPain), 
             stat="identity") +
    geom_hline(yintercept = 50, color =c("black")) +
    scale_fill_manual(values = legend_pal,
                      labels = c("not constant pain", "constant pain")) +
    coord_flip() +
    labs(x = "", y = "Percentage of respondents (%)") +
    ggtitle("RESTORE: constant Pain in the paretic arm?") +
    theme_classic() + theme(legend.title = element_blank())

```



```{r,  include=FALSE}
  movePain_sum <- UEpain.df %>%
  group_by(moveArmPain) %>%  # grouping by these two variables
  tally() %>%  # counting the number of responses
  mutate(perc = n / sum(n) * 100) %>%
  dplyr::select(-n) # %>%
# tidyr::spread(moveArmPain, perc)

movePain_sum$moveArmPain <- as.factor(movePain_sum$moveArmPain)
```



```{r}
legend_pal <- c("#807dba", "#bd0026")
ggplot() +
    geom_bar(data = movePain_sum, aes(x= as.factor(1), y=perc, fill = moveArmPain), 
             stat="identity") +
    geom_hline(yintercept = 50, color =c("black")) +
    scale_fill_manual(values = legend_pal,
                      labels = c("no pain when moving", "pain when moving")) +
    coord_flip() +
    labs(x = "Time of survey", y = "Percentage of respondents (%)") +
    ggtitle("RESTORE: Pain in the paretic arm when moving?") +
    theme_classic() + theme(legend.title = element_blank())

```


```{r,  include=FALSE}
# nightPain_sum <- unique(pain2_noCNTRLS.df[, c(1, 15, 21)]) %>%
nightPain_sum <- UEpain.df %>%
  group_by(nightArmPain) %>%  # grouping by these two variables
  tally() %>%  # counting the number of responses
  mutate(perc = n / sum(n) * 100) %>%
  dplyr::select(-n) # %>%
# tidyr::spread(nightArmPain, perc)

nightPain_sum$nightArmPain <- as.factor(nightPain_sum$nightArmPain)

```


```{r}
legend_pal <-c("#081d58", "#bd0026")
ggplot() +
    geom_bar(data = nightPain_sum, aes(x= as.factor(1), y=perc, fill = nightArmPain), 
             stat="identity") +
    geom_hline(yintercept = 50, color =c("black")) +
    scale_fill_manual(values = legend_pal,
                      labels = c("no pain during night", "waking with pain at night")) +
    coord_flip() +
    labs(x = "Time of survey", y = "Percentage of respondents (%)") +
    ggtitle("RESTORE: Pain in the paretic arm waking at night?") +
    theme_classic() + theme(legend.title = element_blank())

```



Correlation between domains related to upper extremity pain ((based on ))non-standardized questions documented in RESTORE


# Logistic regression: UE pain predicted by time post-stroke

no pain in the affected UE
```{r}
new.df <- pain2_noCNTRLS.df[, c(21:25)]
new.df[, c(2:5)] <- lapply(new.df[, c(2:5)], as.factor)
str(new.df)


#  separate logistic regression models
s2 <- glm(noArmPain ~ time.post.stroke, 
          data = new.df, family = binomial)
summary(s2)
report_text(s2)
predicted2 <- estimate_relation(s2, data = "grid")
preds2 <- plot(predicted2) 
preds2 + theme_modern()
```

constant pain in the affected UE
```{r}
s3<- glm(constantArmPain ~ time.post.stroke, 
          data = new.df, family = binomial)

# plot(parameters(s3))
tab_model(s3, show.stat = T, collapse.ci = TRUE, digits = 3)
report_text(s3)
predicted3 <- estimate_expectation(s3, data = "grid")
preds3 <- plot(predicted3) 
preds3 + theme_modern()

```


Movement-related pain in the affected UE
```{r}

s4<- glm(moveArmPain ~ time.post.stroke, 
         data = new.df, family = binomial)
tab_model(s4, show.stat = T, collapse.ci = TRUE)
report_text(s4)

```

Arm pain during the night
```{r}
s5<- glm(nightArmPain ~ time.post.stroke, 
         data = new.df, family = binomial)

# plot(parameters(s5))
tab_model(s5, show.stat = T, collapse.ci = TRUE, digits = 5)
report_text(s5)
predicted <- estimate_expectation(s5, data = "grid")
preds5 <- plot(predicted) 
preds5 + theme_modern()

```


#       EuroQol data
Frequencies for EQ5 subdomains
```{r}
pain.df <- pain1.df
# str(pain.df)
# > length(unique(pain.df$Rex.ID))
# [1] 348
# > length(unique(pain.df$RESTORE.ID))
# [1] 348
pain.df$AnxDep <- as.factor(pain.df$Anxiety.Depression)
pain.df$PainDisco <- as.factor(pain.df$Pain.Discomfort)



# Frequency Plots:
ggplot(pain.df, aes(Pain.Discomfort, color = PainDisco)) +
  geom_freqpoly(bins = 5)+
  ggtitle("EQ5: Pain & Discomfort") +
  theme_modern()

ggplot(pain.df, aes(Pain.Discomfort, colour = AnxDep)) +
  geom_freqpoly(bins = 5)+
  ggtitle("EQ5: Anxiety & Depression") +
  theme_modern()

ggplot(pain.df, aes(Health.Today, color = PainDisco)) +
  geom_freqpoly(bins = 5)+
  ggtitle("EQ5: Health today") +
  theme_modern()

```


Correlation between EQ5 sub-domains

```{r}
# str(pain1.df)
eqord <- c(6:11)
# pain1.df[eqord] <- lapply(pain1.df[eqord], as.character)
# pain1.df[eqord] <- lapply(pain1.df[eqord], as.factor)
eq5_corr <- correlation(pain1.df[eqord], method = "kendall")
eq2 <- summary(eq5_corr)
summary(eq5_corr)
# png(height = 1000, width = 1700, res = 300, pointsize = 15, file = "corrmatEQ5D5L.png")
peq2 <- plot(eq2)
peq2 +    theme_modern()

```


#  DEMOGRAPHICS

```{r, include = FALSE}

str(pain2_noCNTRLS.df)
ID.df <- pain2_noCNTRLS.df[, c("RESTORE.ID", "Registry.ID", "Ethnicity", "Race", "time.post.stroke")]
ID.df <- as.data.frame(unique( ID.df))
# str(ID.df)

# str(stroke.df) #REX + RESTORE, MDS data
# str(demo.df) #RESTORE - including dob, sex, date of stroke, side of stroke -> compute time.post.stroke (again?)
# str(demo1.df) #REX

#  check difference between IDs (N = 1294 vs 1284)
idDiff <- setdiff(pain2_noCNTRLS.df$RESTORE.ID, demo.df$Registry.ID)
# nothing

# RESTORE DATA SET:
demo.df$RESTORE.ID <- demo.df$Registry.ID

```



```{r, include=TRUE}
# TO DO: remove overlap with control data set from demo.df  

demo.df$Date.of.Birth <- as.Date(demo.df$Date.of.Birth,
                                 format = "%Y-%m-%d")

demo.df$STROKE.Date <- as.Date(demo.df$Date., # date of assessment?
                               format = "%Y-%m-%d")

#  CAVE: stroke date in RESTORE = most recent stroke (i..e, negative time difference with assessment instances may result for patients with several strokes)
demo.df$age.at.stroke <- NA
for (i in 1:nrow(demo.df)) {
  if (!is.na(demo.df$STROKE.Date[i])) {
    demo.df$age.at.stroke[i] <- time_length(difftime(demo.df$STROKE.Date[i], demo.df$Date.of.Birth[i]),"years")
  }
}  


demo.df <- mutate_if(demo.df, is.character, as.factor)
names(demo.df)[7] <- "LesionHemisphere"

tab1 <- demo.df[, c("RESTORE.ID", "Gender", "LesionHemisphere", "age.at.stroke")] %>%
  group_by(Gender) %>%
  report_table()

kbl(tab1 ) %>%
  kable_paper(full_width = F)

#  merge data frames and avoid doubling of entries
# str(pain2_noCNTRLS.df)

demo_RESTORE.df <- demo.df[, c("RESTORE.ID", "Gender", "LesionHemisphere", "age.at.stroke")]  %>% 
  # dplyr::right_join(pain2_noCNTRLS.df[, c(15, 17)], by = "RESTORE.ID")
  dplyr::right_join(pain2_noCNTRLS.df, by = "RESTORE.ID")

```

add age at assessment and control dublicates

```{r, include = FALSE}
demo_RESTORE.df$age.at.assessment <- demo_RESTORE.df$age.at.stroke + (demo_RESTORE.df$time.post.stroke)/356
# str(demo_RESTORE.df)
dim(demo.df) #N=1562
dim(pain2_noCNTRLS.df) # N=2098
length(unique(demo_RESTORE.df$RESTORE.ID)) #1530

dubli <- demo_RESTORE.df %>%
  group_by(RESTORE.ID) %>%
  summarise(n=sum(n())) %>%
  filter(n>1)

length(unique(dubli$RESTORE.ID)) #415
max(dubli$n) #5

```


```{r}
tab1 <- report_table(as.data.frame(lapply(demo_RESTORE.df[, c("Gender", "LesionHemisphere")], as.factor)))
kbl(tab1) %>%
  kable_paper(full_width = F)

tab2 <- report_table(demo_RESTORE.df[, c("age.at.stroke", "time.post.stroke", "age.at.assessment", "Race", "Ethnicity")])
kbl(tab2) %>%
  kable_paper(full_width = F)

```


```{r, include=FALSE}
# using finalfit package: Specify explanatory variables of interest
demo_RESTORE.df$affectedArmPain <-  as.factor(plyr::mapvalues(  demo_RESTORE.df$noArmPain, from = c("0", "1"), to = c("1", "0"))) 
demo_RESTORE.df$affectedArmPain <- factor(demo_RESTORE.df$affectedArmPain,
                                          levels = c(0, 1),
                                          labels = c("no pain", "pain")
)
levels(demo_RESTORE.df$affectedArmPain) # first level given will be reference, i.e., within the. model, the influence of the predictor on the presence of pain will be tested

demo_RESTORE.df$Ethnicity <- as.factor(demo_RESTORE.df$Ethnicity)
demo_RESTORE.df$Race <- as.factor(demo_RESTORE.df$Race)
demo_RESTORE.df$age_range <- as.factor(cut(demo_RESTORE.df$age.at.assessment,
                                           breaks=c(-Inf, 40, 60, Inf),
                                           labels=c("<40","40-60",">60")))

demo_RESTORE.df$YrsPostStroke_range <- as.factor(cut(demo_RESTORE.df$time.post.stroke, 
                                           breaks=c(-Inf, 352, 704, Inf),
                                           labels=c("<1yr","1-2yrs",">2yrs")))

dependent = "affectedArmPain"
explanatory = c("age_range", "YrsPostStroke_range", "Gender", "LesionHemisphere", "Race") #, "Ethnicity")

# demo_RESTORE.df %>%
#   dplyr::filter(! LesionHemisphere %in% c("", "Unknown"), na.rm = TRUE) %>%
#   summary_factorlist(dependent, explanatory)
# 
# demo_RESTORE.df %>% 
#   dplyr::filter(! LesionHemisphere %in% c("", "Unknown"), na.rm = TRUE) %>%
#   summary_factorlist(dependent, explanatory, 
#                      p=TRUE, na_include=TRUE)
```

Table   
```{r}
demo_RESTORE.df %>% 
  dplyr::filter(! LesionHemisphere %in% c("", "Unknown"), na.rm = TRUE) %>%
  # mutate(
  #   nodes = ff_label(nodes, "Lymph nodes involved")
  # ) %>%
  summary_factorlist(dependent, explanatory, 
                     p=TRUE, na_include=TRUE, 
                     add_dependent_label=TRUE) -> table1
kbl(table1) %>%
  kable_paper(full_width =F)

# # library(tableHTML)
# write_tableHTML(tableHTML(table1, rownames=T, round =2, collapse = 'separate_shiny') %>%
#         add_theme('scientific'), 
#         file = "StrokePain_Table1.html")

## Save objects for knitr/markdown
# save(table1, dependent, explanatory, file = "out.rda")
# kable(table1, row.names=FALSE, align=c("l", "l", "r", "r", "r", "r"))

```
Predicting pain in the affected UE

```{r, include = FALSE}
# demo_RESTORE.df$affectedArmPain <- as.factor(demo_RESTORE.df$affectedArmPain)
demo_RESTORE.df %>% 
  dplyr::filter(! LesionHemisphere %in% c("", "Unknown"), na.rm = TRUE) %>%
finalfit(dependent, explanatory, 
         metrics = TRUE,
         dependent_label_prefix = "") -> table2

kbl(table2) %>%
  kable_paper(full_width =F)
```


```{r, include=FALSE}
demo_RESTORE.df  %>% 
  dplyr::filter(! LesionHemisphere %in% c("", "Unknown"), na.rm = TRUE) %>%
  or_plot(dependent, explanatory, 
          dependent_label = "pain",
          remove_ref = FALSE,
          breaks = c(0.5, 1, 5, 10, 20, 30))
```


```{r, include=FALSE}
# validate with https://statsandr.com/blog/binary-logistic-regression-in-r/#linear-versus-logistic-regression and compare with
# https://bookdown.org/sarahwerth2024/CategoricalBook/logistic-regression-r.html


demo_RESTORE.df$affectedArmPain <-  as.factor(plyr::mapvalues(  demo_RESTORE.df$noArmPain, from = c("0", "1"), to = c("1", "0"))) 
demo_RESTORE.df$affectedArmPain <- factor(demo_RESTORE.df$affectedArmPain,
                            levels = c(0, 1),
                            labels = c("no pain", "pain")
)
levels(demo_RESTORE.df$affectedArmPain) # first level given will be reference, i.e., within the. model, the influence of the predictor on the presence of pain will be tested
```

## Separate logistic regressions on the main variables of interest

#### Gender
```{r, include=FALSE}
m1 <- glm(affectedArmPain ~ Gender, 
          data = demo_RESTORE.df, 
          family = "binomial")

tab_model(m1)
plot_model(m1, type = "pred", terms = "Gender") + labs(y = ("p[affected arm pain]"))
```

#### Age (at assessment)
```{r, include=FALSE}
m2 <- glm(affectedArmPain ~ age.at.assessment, 
          data = demo_RESTORE.df, 
          family = "binomial")

tab_model(m2)
plot_model(m2, type = "pred", terms = "age.at.assessment") + labs(y = ("p[affected arm pain]"))
```

#### Time since stroke
```{r, include=FALSE}
m3 <- glm(affectedArmPain ~ time.post.stroke, 
          data = demo_RESTORE.df, 
          family = "binomial")

tab_model(m3)
plot_model(m3, type = "pred", terms = "time.post.stroke") + labs(y = ("p[affected arm pain]"))
```

#### Lesioned hemisphere
```{r, include=FALSE}

# levels(demo_RESTORE.df$LesionHemisphere) -> to do: remove levels "" & "Unknown" // relevel to reference "Left"
m4 <- glm(affectedArmPain ~ LesionHemisphere,
          data = demo_RESTORE.df, 
          family = "binomial")

tab_model(m4)
plot_model(m4, type = "pred", terms = "LesionHemisphere") + labs(y = ("p[affected arm pain]"))
```

#### Race
```{r, include=FALSE}
# levels(demo_RESTORE.df$Race) -> to do: remove levels "" // relevel to reference "White or Caucasian"
m5 <- glm(affectedArmPain ~ Race,
          data = demo_RESTORE.df, 
          family = "binomial")

tab_model(m5)
plot_model(m5, type = "pred", terms = "Race") + labs(y = ("p[affected arm pain]"))
```

#### Ethnicity
```{r, include=FALSE}
m6 <- glm(affectedArmPain ~ Ethnicity,
          data = demo_RESTORE.df, 
          family = "binomial")

tab_model(m6)
plot_model(m6, type = "pred", terms = "Ethnicity") + labs(y = ("p[affected arm pain]"))

```

### Full regression model 
*without Ethnicity due to singularity*

```{r}
m7 <- glm(affectedArmPain ~ Gender + time.post.stroke + LesionHemisphere + Race ,
          data = demo_RESTORE.df, 
          family = "binomial")

tab_model(m7)
plot_model(m7, type = "pred", terms = c("time.post.stroke", "Gender", "LesionHemisphere")) + labs(y = ("p[affected arm pain]"))

```

removing empty or unknown factor levels

```{r, include = FALSE }
data <- demo_RESTORE.df[, c("RESTORE.ID", "affectedArmPain", "time.post.stroke", "Gender", "Race", "LesionHemisphere", "age.at.stroke", "age.at.assessment")] %>%
  dplyr::filter(! LesionHemisphere %in% c("", "Unknown") & ! Race %in% c("", "Unknown")) %>%
  droplevels()

data$Gender <- relevel(data$Gender, ref = "Male")
data$LesionHemisphere <- relevel(data$LesionHemisphere, ref = "Left")
data$Race <- relevel(data$Race, ref = "White or Caucasian")
min(data$time.post.stroke, na.rm = TRUE)

# str(data)
```

Rerun models without missing/na

```{r}
dependent = "affectedArmPain"
explanatory = c("time.post.stroke", "age.at.stroke", "Gender", "LesionHemisphere", "Race") #, "Ethnicity")

data %>% 
  finalfit(dependent, explanatory, 
           metrics = TRUE,
           dependent_label_prefix = "") -> table2new
kbl(table2new) %>%
   kable_paper(full_width = F)
  

```



```{r}
data  %>% 
  or_plot(dependent, explanatory, 
          dependent_label = "pain in the affected UE",
          remove_ref = FALSE,
          breaks = c(0.5, 1, 5, 10, 20, 30))



m3new <- glm(affectedArmPain ~ time.post.stroke, 
          data = data, 
          family = "binomial")

tab_model(m3new)
plot_model(m3new, type = "pred", terms = "time.post.stroke [all]") + labs(y = ("p[affected arm pain]"), x = "days post stroke")

```

##  Full model 
*(leaving out Ethnicity due to singularity)*

```{r}

m7new <- glm(affectedArmPain ~ Gender + time.post.stroke + age.at.assessment + LesionHemisphere + Race ,
          data = data, 
          family = "binomial")

tab_model(m7new)

plot_model(m7new, type = "pred", terms = c("time.post.stroke [all]", "Gender", "LesionHemisphere")) + labs(y = ("p[affected arm pain]"))

plot_model(m7new, type = "pred", terms = c("age.at.assessment [all]", "Gender", "LesionHemisphere")) + labs(y = ("p[affected arm pain]"))

plot_model(m7new, type = "pred", terms = c("Gender", "Race")) + labs(y = ("p[affected arm pain]"))
plot_model(m7new, type = "pred", terms = c("Race", "Gender")) + labs(y = ("p[affected arm pain]"))

```




#    MDS data 
 
 Questions from /Users/Kirstin/Library/CloudStorage/OneDrive-MedicalUniversityofSouthCarolina/Documents/OnGoingStudies/PAIN/PAINassessmentREXRESTORE/PainScreening_20230519.pdf

```{r, include=FALSE}

# str(mds.df)
dim(mds.df) # N>196? - update?  
length(unique(as.factor(mds.df$"Rex ID"))) # 22 with >1 data points

# str(mds_wong.df) # -> this is the pain intensity with the NRS included in the Wong-Baker-Faces
levels(as.factor(mds_wong.df$Score)) 

```


 ..combine mds.df + mds_wong.df ...

```{r, include=FALSE}

# str(mds.df)
# str(mds_wong.df)
colnames(mds.df)[c(1:5)] <- c("REX.ID", "RESTORE.ID", "StudyCode", "Study.ID", "DateOfEvaluation")
colnames(mds_wong.df) <- c("REX.ID", "RESTORE.ID", "StudyCode", "Study.ID" , "DateOfEvaluation",  "PainIntensityScore")

names <- c(1:4) 
mds.df[,names] <- lapply(mds.df[,names] , factor)
mds_wong.df[,names] <- lapply(mds_wong.df[,names] , factor)


mds_cmb.df <- mds.df %>%
  dplyr::left_join(mds_wong.df, 
                   by = c("RESTORE.ID", "REX.ID", "StudyCode", "Study.ID", "DateOfEvaluation")
                  # ,unmatched = "error"
                  )
# str(mds_cmb.df)
```

... and then merge with demographic data

```{r, include=FALSE}
demo_RESTORE.df$RESTORE.ID <- factor(demo_RESTORE.df$RESTORE.ID)

mds_demo.df <- mds_cmb.df %>%
  dplyr::left_join(demo_RESTORE.df[, c("RESTORE.ID", "Gender", "LesionHemisphere", "age.at.stroke", "Race", "Ethnicity")], by = "RESTORE.ID", 
                   multiple = "first" #, unmatched = "error"
                   )
# head(mds_demo.df)

rows_with_na <- mds_demo.df %>%
  dplyr::filter(is.na(Gender))
dim(rows_with_na)

data <- mds_demo.df

# data %>%
#   dplyr::filter(`Experienced Pain`== "yes") %>%
#   # group_by(Gender) %>%
#   # group_by(Race) %>%
#   tally()
# 
# data %>%
#   dplyr::filter(`Experienced Pain`== "no") %>%
#   group_by(Gender) %>%
#   # group_by(Race) %>%
#   tally()
# 
# data %>%
#   dplyr::filter(`Pain Related To Stroke`== "yes") %>%
#   group_by(Gender) %>%
#   # group_by(Race) %>%
#   tally()
# 
# data %>%
#   dplyr::filter(`Pain Related To Stroke`== "no") %>%
#   group_by(Gender) %>%
#   # group_by(Race) %>%
#   tally()

```


###  Location of perceived pain

```{r, include=FALSE}

data %>%
  group_by(Gender) %>%
  # group_by(Race) %>%
  summarize(across(8:27, sum))

data %>%
  # dplyr::filter(`Experienced Pain` == "yes") %>%
  group_by(`Experienced Pain`) %>%
  tally()

pain_loc <- data[, c(4:6, 8:27, 48:52), ] %>%
  dplyr::filter(`Experienced Pain` == "yes") %>%
  tidyr::pivot_longer(
    cols = "Pain Location Head" : "Pain Location Shoulder Unaffected", 
    names_to = "pain_location",
    names_prefix = "Pain Location ",
    values_to = "painloc_eval",
    values_drop_na = FALSE
  )

 levels(as.factor(pain_loc$pain_location))
 pain_loc$pain_location  <-  plyr::mapvalues(pain_loc$pain_location ,
                                              from = c("Hand Unaffected...22", "Hand Unaffected...23", "Knee Unaffected...24", "Knee Unaffected...25"),
                                              to = c("Hand Unaffected","Hand Unaffected", "Knee Unaffected", "Knee Unaffected" ))
 painLw <- pain_loc %>%
   tidyr::pivot_wider(
     id_cols = c("Study.ID", "DateOfEvaluation", "Gender", "Race", "Ethnicity", "LesionHemisphere", "age.at.stroke"),
     names_from = "pain_location", 
     values_from = "painloc_eval",
     values_fn = mean
   )
 
 # str( painLw )

 pain_recoded <- painLw %>%
   mutate(across(8:25,
                 ~.x %>%
                   zap_labels() %>%
                   as.logical()
   ))
 
 # str(pain_recoded)
 
N <- length(unique(pain_recoded$Study.ID))
Nm <- pain_recoded %>%
  dplyr::filter(Gender == "Male")  %>%
  distinct(Study.ID) %>%
  tally()
Nw = N-Nm

Loc_summary <- pain_recoded %>%
  group_by(Gender) %>%
   summarize(across(where(is.logical), sum))

Loc_sum <- Loc_summary %>%
  tidyr::pivot_longer(
    cols = `Head` : `Shoulder Unaffected`, 
    names_to = "Pain location",
    # names_prefix = "Pain Location ",
    values_to = "Count",
    values_drop_na = FALSE
  )

Loc_sum$`Pain location`<-factor(Loc_sum$`Pain location`, levels = c(   "Head",  "Neck"  , "Chest Breast"    , "Belly" , "Upper Back" , "Lower Back",    
                                                                       "Hand Affected",  "Arm Affected",  "Shoulder Affected" , "Foot Affected" ,"Knee Affected" , "Hip Affected",
                                                                      "Hand Unaffected" ,  "Arm Unaffected", "Shoulder Unaffected" , "Foot Unaffected", "Knee Unaffected" ,"Hip Unaffected"))

```


```{r}
Loc_sum %>%
  ggplot(aes(x = forcats::fct_rev(`Pain location`), y = Count, fill = Gender)) +
  geom_bar(position = position_dodge(0.8), stat = "identity") +
  scale_fill_discrete_c4a_div() +
  coord_flip() +
  # facet_grid(~Gender) +
  theme_classic()
```

### In % of the respective subgroup N

```{r}
Loc_perc <- Loc_sum %>%
group_by(Gender) %>%
  mutate(Count_Gender = sum(Count)) %>%
  group_by(Gender) %>%
  mutate(freq = Count/Count_Gender, 
         freq_perc = freq*100 %>%
           round(2))

Loc_perc %>%
  ggplot(aes(x = forcats::fct_rev(`Pain location`), y = freq_perc, fill = Gender)) +
  geom_bar(position = position_dodge(0.8), stat = "identity") +
  scale_fill_discrete_c4a_div() +
  coord_flip() +
  # facet_grid(~Gender) +
  theme_classic()
```



```{r, include=FALSE} 
Loc_summary2<- pain_recoded %>%
  group_by(Race) %>%
  summarize(across(where(is.logical), sum))


Loc_sum2 <- Loc_summary2 %>%
  tidyr::pivot_longer(
    cols = `Head` : `Shoulder Unaffected`, 
    names_to = "Pain location",
    # names_prefix = "Pain Location ",
    values_to = "Count",
    values_drop_na = FALSE
  )

Loc_sum2$`Pain location`<-factor(Loc_sum2$`Pain location`, levels = c( "Head",  "Neck"  , "Chest Breast"    , "Belly" , "Upper Back" , "Lower Back",    
                                                                        "Hand Affected",  "Arm Affected",  "Shoulder Affected" , "Foot Affected" ,"Knee Affected" , "Hip Affected",
                                                                        "Hand Unaffected" ,  "Arm Unaffected", "Shoulder Unaffected" , "Foot Unaffected", "Knee Unaffected" ,"Hip Unaffected"))
```


```{r}

Loc_sum2 %>%
  ggplot(aes(x = forcats::fct_rev(`Pain location`), y = Count, fill = Race)) +
  geom_bar(position = position_dodge(0.8), stat = "identity") +
  scale_fill_discrete_c4a_seq() +
  coord_flip() +
  # facet_grid(~Gender) +
  theme_classic()
 
```




###   Frequency of perceived pain

```{r, include=FALSE}

levels(as.factor(data$`How Often`))

data %>%
  dplyr::filter(!is.na(`How Often`)) %>%
  mutate(`How Often` = factor(`How Often`)) %>%
  group_by(`How Often`, Gender) %>%
  tally()

temp <- data %>%
  dplyr::filter(!is.na(`How Often`)) 

temp$PainFreq <-factor(temp$`How Often`, levels = c("less_than_one_day", "one_to_three_days",  "most_days", "every_day"))
levels(temp$PainFreq)

items <- data.frame(temp[, c("PainFreq")])

items_likert <- items %>%
  likert()
```


```{r}
p1 <- plot(items_likert,
     group.oder = names(items),
     plot.percents = TRUE,
     plot.percent.low = FALSE,
     plot.percent.high = FALSE,
     centered = FALSE,
     wrap = 30)

p1 + scale_fill_brewer(palette = "RdPu")

```



###   Intensity of perceived pain

```{r}

levels(as.factor(data$PainIntensityScore))
length(data$PainIntensityScore)

data %>%
  dplyr::filter(!is.na(PainIntensityScore)) %>%
  mutate(`How Often` = factor(`How Often`)) %>%
  group_by(PainIntensityScore, Gender) %>%
  tally()

temp <- data %>%
  dplyr::filter(!is.na(PainIntensityScore)) 

temp$PainIntensityScore  <-  plyr::mapvalues(temp$PainIntensityScore ,
                                                       from = c(0, 2, 4, 6, 8, 10),
                                                       to = c("No Hurt","Hurts Little Bit","Hurts Little More","Hurts Even More", "Hurts Whole Lot","Hurts Worst"))

temp$PainIntensityScore  <- factor(temp$PainIntensityScore, levels = c("No Hurt","Hurts Little Bit","Hurts Little More","Hurts Even More", "Hurts Whole Lot","Hurts Worst"))
levels(temp$PainIntensityScore)
                                          
items <- data.frame(temp[, c("PainIntensityScore")])
# str(items)

items_likert <- items %>%
  likert()


p2 <- plot(items_likert, 
           group.oder = names(items),
           plot.percents = TRUE, 
           plot.percent.low = FALSE, 
           plot.percent.high = FALSE, 
           centered = FALSE, 
           wrap = 30)

p2 + scale_fill_brewer(palette = "OrRd", direction = 1)

```


###   Situations of pain occurrence

```{r}

occ_summary <- mds_demo.df %>%
  group_by(Gender) %>%
  summarize(across(c(29,31:36), sum))


occ_sum <- occ_summary %>%
  tidyr::pivot_longer(
    cols = `When Other` : `When During The Night`, 
    names_to = "Pain occurrence",
    names_prefix = "When ",
    values_to = "Count",
    values_drop_na = FALSE
  )


occ_sum %>%
  ggplot(aes(x = `Pain occurrence` , y = Count, fill = Gender)) +
  geom_bar(position = position_dodge(0.8), stat = "identity") +
  scale_fill_discrete_c4a_div() +
  coord_flip() +
  # facet_grid(~Gender) +
  theme_classic()

```


```{r}
occ_summary2 <- mds_demo.df %>%
  group_by(Race) %>%
  summarize(across(c(29,31:36), sum))


occ_sum2 <- occ_summary2 %>%
  tidyr::pivot_longer(
    cols = `When Other` : `When During The Night`, 
    names_to = "Pain occurrence",
    names_prefix = "When ",
    values_to = "Count",
    values_drop_na = FALSE
  )


occ_sum2 %>%
  ggplot(aes(x = `Pain occurrence` , y = Count, fill = Race)) +
  geom_bar(position = position_dodge(0.8), stat = "identity") +
  scale_fill_discrete_c4a_seq() +
  coord_flip() +
  # facet_grid(~Gender) +
  theme_classic()
```


###  Other situations when pain occurs 
```{r}

levels(as.factor(mds.df$`Other When Do You Feel Pain`))

```

###   Strategies of pain management

```{r}

mgm_summary <- mds_demo.df %>%
  group_by(Gender) %>%
  summarize(across(c(37,39:46), sum))


mgm_sum <- mgm_summary %>%
  tidyr::pivot_longer(
    cols = `Management Of Pain Other` : `Management Of Pain Cannot Do Anything`, 
    names_to = "Pain management",
    names_prefix = "Management Of Pain ",
    values_to = "Count",
    values_drop_na = FALSE
  )


mgm_sum %>%
  ggplot(aes(x = `Pain management` , y = Count, fill = Gender)) +
  geom_bar(position = position_dodge(0.8), stat = "identity") +
  scale_fill_discrete_c4a_div() +
  coord_flip() +
  # facet_grid(~Gender) +
  theme_classic()



mgm_summary2 <- mds_demo.df %>%
  group_by(Race) %>%
  summarize(across(c(37,39:46), sum))


mgm_sum2 <- mgm_summary2 %>%
  tidyr::pivot_longer(
    cols = `Management Of Pain Other` : `Management Of Pain Cannot Do Anything`, 
    names_to = "Pain management",
    names_prefix = "Management Of Pain ",
    values_to = "Count",
    values_drop_na = FALSE
  )


mgm_sum2 %>%
  ggplot(aes(x = `Pain management` , y = Count, fill = Race)) +
  geom_bar(position = position_dodge(0.8), stat = "identity") +
  scale_fill_discrete_c4a_seq() +
  coord_flip() +
  # facet_grid(~Gender) +
  theme_classic()
```


###  Other strategies of pain management

```{r}
levels(as.factor(mds_demo.df$`Other Pain Management`))

```

# Association between pain and depression/anxiety as measured with PHQ-8 

```{r, include=FALSE}
#  str(phq.df)
length(unique(phq.df$`Study ID`))
hist(phq.df$`Total Score`)

#  combine with mds_demo.df

phq.df <- mutate_if(phq.df, is.character, as.factor)
phq.df$DateOfEvaluation <- as.Date(phq.df$`Date Of Evaluation`,
                                 format = "%Y-%m-%d")
phq.df <- phq.df %>%
  dplyr::rename(REX.ID =`Rex ID`, 
                RESTORE.ID = `RESTORE ID`,
                Study.ID = `Study ID`, 
                StudyCode = `Study Code`, 
                PHQtotal =`Total Score`)

mds_demo_phq.df <- mds_demo.df  %>% 
  dplyr::left_join(phq.df, by = c("RESTORE.ID", "REX.ID", "Study.ID", "DateOfEvaluation"))

# str(mds_demo_phq.df)
hist(mds_demo_phq.df$PHQtotal)

```

#### Association between PHQ-8 total score and perceived pain intensity (including 0 = no pain)

*Interpretation of PHQ-8 Scores: 
0-4: No significant depressive symptoms;
5-9: Mild depression;
10-14: Moderate depression;
15-19: Moderately severe depression;
20-24: Severe depression; a score of 10 or higher is generally considered indicative of clinically significant depression. *
```{r}

mds_demo_phq.df[, c("PainIntensityScore", "PHQtotal")] %>%
  correlation()  
summary(eq5_corr)

# png(height = 1200, width = 1700, res = 300, pointsize = 15, file = "painInt_PHQ8.png")

mds_demo_phq.df%>%
ggplot(aes(x = PainIntensityScore, y = PHQtotal)) +
  geom_jitter(size = 2, width = 0.3, alpha = 0.6) +
  geom_smooth(colour = "black", method = "lm", se = TRUE) +
  geom_hline(yintercept = 10, color =c("red"), linetype='dashed') +
  theme_classic()

```




# Association between pain and stroke-specific QoL measured with SIS (3.0) 

The SIS 3.0 is comprised of 8 subscales or ‘Domains’:
Strength
Hand function
ADL/IADL
Mobility
Communication
Emotion
Memory and thinking
Participation
A final single-item domain measures perceived recovery since stroke onset.

Domains are scored on a 1-5 Likert Scale with 
1 = an inability to complete the item
5 = no difficulty experienced at all.
Domain scores range from 0-100 and are calculated using the following equation:
Domain score = [(Mean item score – 1) / 5-1 ] x 100.

A final single-item Recovery domain assesses the individual’s perception of his/her recovery from stroke, measured in the form of a visual analogue scale from 0-100, where:
0 = no recovery
100 = full recovery.


```{r, include=FALSE}
# https://strokengine.ca/en/assessments/stroke-impact-scale-sis/
# str(sis.df)
sis.df <- as.data.frame(sis.df)
sis.df$`Date Of Evaluation` <- as.Date(sis.df$`Date Of Evaluation`,
                             format = "%Y-%m-%d")

sis.df <- sis.df %>%
  dplyr::rename(REX.ID =`Rex ID`, 
                RESTORE.ID = `RESTORE ID`,
                Study.ID = `Study ID`, 
                StudyCode = `Study Code`, 
                DateOfEvaluation = `Date Of Evaluation`) 

temp <- sis.df[, c(1:5)]
# str(temp)

#  for some reason date information gets lost in the next steps and chr are recoded as num
for(i in 6:ncol(sis.df)-1) {
  sis.df[, i] <- as.numeric(substring(sis.df[,c(i)],4,nchar(sis.df[,c(i)])))
}


#  CAVE: CHECK COLUMN NAMES
# [(Mean item score – 1) / 5-1 ] x 100
sis.df$Physical <- ((rowMeans(sis.df[, c(6:9)], na.rm = T) - 1)/(5-1))*100
sis.df$Memory <- ((rowMeans(sis.df[, c(10:18)], na.rm = T) - 1)/(5-1))*100

# Note: Scores for three items in the Emotion domain (3f, 3h, 3i) must be reversed
# before calculating the Emotion domain score (i.e. 1 » 5, 2 » 4, 3 = 3, 4 » 2, 5 » 1).
# The SIS scoring database (see link below) takes this change of direction into account 
# when scoring. When scoring manually, use the following equation to compute the 
# item score for 3f, 3h and 3i: Item score = 6 – individual’s rating.
# >> convert columns with this conversion:
#   3f. Enjoy things as much as ever? -> 24
#   3h. Feel that life is worth living? -> 26
#   3i. Smile and laugh at least once a day? -> 27
# double check
# str(sis.df[, c(24, 26, 27)])

for(i in c(24, 26, 27)) {
  sis.df[, i] <- 6 - sis.df[, i]
}

#  Q1 6:9; Q2 10:18; Q3 18:27, Q4 28:34; Q5 35:45; Q6 46:54; Q7 55:59; Q8 60:67; Q9 68 
sis.df$Emotion <- ( (rowMeans(sis.df[, c(19:27)], na.rm = T) - 1)/ (5-1) ) *100
sis.df$Communication <- ( (rowMeans(sis.df[, c(28:34)], na.rm = T) - 1)/ (5-1) ) *100
sis.df$ADL <- ( (rowMeans(sis.df[, c(35:45)], na.rm = T) - 1)/ (5-1) ) *100
sis.df$Mobility <- ( (rowMeans(sis.df[, c(46:54)], na.rm = T) - 1)/ (5-1) ) *100
sis.df$Handfunction <- ( (rowMeans(sis.df[, c(55:59)], na.rm = T) - 1)/ (5-1) ) *100
sis.df$Participation <- ( (rowMeans(sis.df[, c(60:67)], na.rm = T) - 1)/ (5-1) ) *100
sis.df$Recovery <- as.numeric(sis.df$`Q9 Stroke Recovery`)

# str(sis.df)

sisDom <- sis.df[, c(1:5, 69:ncol(sis.df))]
# str(sisDom)

# replace first five columns with temp
sisDom[, c(1:5)] <- temp[, c(1:5)]

length(unique(sisDom$RESTORE.ID))
length(unique(sisDom$REX.ID))
length(unique(sisDom$Study.ID))

```

```{r}

hist(sisDom$Physical)
hist(sisDom$Memory)
hist(sisDom$Emotion)
hist(sisDom$Communication)
hist(sisDom$Mobility)
hist(sisDom$Handfunction)
hist(sisDom$Participation)
hist(sisDom$Recovery) 

```

### Association with perceived pain intensity reported in MDS data

```{r, include=FALSE}
#  combine with MDS 
mds_demo_sis.df <- mds_demo.df  %>% 
  dplyr::left_join(sisDom, by = c("RESTORE.ID", "REX.ID", "Study.ID", "DateOfEvaluation"))

```


```{r}
mds_demo_sis.df %>%
correlation(select = c("PainIntensityScore"), 
            select2 = c("Physical", "Memory", "Emotion", 
                        "Communication", "ADL", "Mobility", 
                        "Handfunction", "Participation", "Recovery")
            )  

mds_demo_sis.df%>%
ggplot(aes(x = PainIntensityScore, y = Emotion)) +
  geom_jitter(width = 0.2, alpha = 0.6) +
  geom_smooth(colour = "red", method = "lm", se = TRUE) +
  theme_classic()


# png(height = 1200, width = 1700, res = 300, pointsize = 15, file = "painInt_SISpartici.png")
mds_demo_sis.df%>%
ggplot(aes(x = PainIntensityScore, y = Participation)) +
  geom_jitter(width = 0.4, alpha = 0.5, size = 2) +
  geom_smooth(colour = "red", method = "lm", se = TRUE) +
  theme_classic()


mds_demo_sis.df%>%
ggplot(aes(x = PainIntensityScore, y = Recovery)) +
  geom_jitter(width = 0.2, alpha = 0.6) +
  geom_smooth(colour = "red", method = "lm", se = TRUE) +
  theme_classic()


```


# Prediction of experienced pain ('yes') with SIS domains?

*spoiler: not really based on MDS data*

```{r, include = FALSE}

# mds_demo_sis.df$`Experienced Pain`



data <- mds_demo_sis.df[, c("Experienced Pain", "Physical", "Memory", "Emotion", 
                        "Communication", "ADL", "Mobility", 
                        "Handfunction", "Participation", "Recovery")] 

data$ExperiencedPain <- as.factor(data$`Experienced Pain`)
data$ExperiencedPain <- factor(data$ExperiencedPain,
                            levels = c("no", "yes")
)
# levels(data$ExperiencedPain) # -> first level will be reference in the following

dependent = "ExperiencedPain"
explanatory = c("Physical", "Memory", "Emotion", 
                        "Communication", "ADL", "Mobility", 
                        "Handfunction", "Participation", "Recovery")
```

```{r}
data %>% 
  finalfit(dependent, explanatory, 
           metrics = TRUE,
           dependent_label_prefix = "") -> table3new
kbl(table3new) %>%
   kable_paper(full_width = F)
  

```



```{r}

data  %>% 
  or_plot(dependent, explanatory, 
          dependent_label = "experienced pain [yes]",
          remove_ref = FALSE,
          breaks = c(0.5, 1, 5, 10, 20, 30))

```

Only higher ratings in SIS-Participation domain seems to be associated with a reduced likelihood of experienced pain.
Higher ratings of SIS-Mobility on the other hand apparently tend to predict increased likelihood of reported pain, which is not exactly visible in the separate logistic regression.  

*yes = 1, no = 0*

```{r}
data$ExperiencedPain <-  as.factor(plyr::mapvalues( data$ExperiencedPain, from = c("yes", "no"), to = c("1", "0")))

ms1 <- glm(ExperiencedPain ~ Participation, 
          data = data, family = binomial)
summary(ms1)
report_text(ms1)
predicted.ms1 <- estimate_relation(ms1, data = "grid")
preds.ms1 <- plot(predicted.ms1) 
preds.ms1 + theme_modern()

```
```{r}
ms2 <- glm(ExperiencedPain ~ Mobility, 
          data = data, family = binomial)
summary(ms2)
report_text(ms2)
predicted.ms2 <- estimate_relation(ms2, data = "grid")
preds.ms2 <- plot(predicted.ms2) 
preds.ms2 + theme_modern()

```
